# handlers/images.py
from t
from telegram.ext import ContextTypes
from utils.db import get_membership_level
from utils.ocr import extract_text_from_image, parse_profit_loss_text
import logging

logger = logging.getLogger(__name__)

async def handle_image(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    å¤„ç†ç”¨æˆ·å‘é€çš„å›¾ç‰‡æ¶ˆæ¯ï¼Œæ‰§è¡ŒOCRå¹¶åˆ†æå†…å®¹
    """
    user_id = update.effective_user.id
    membership_level = get_membership_level(user_id)
    
    if not membership_level:
        await update.message.reply_text("ğŸ‰ æ–°ç”¨æˆ·æ¬¢è¿ï¼è¯·è”ç³»ç®¡ç†å‘˜é¢†å–æ¿€æ´»ç ä»¥ä½“éªŒåˆçº§ä¼šå‘˜æƒé™ã€‚")
        return
    
    # è·å–å›¾ç‰‡æ–‡ä»¶
    try:
        photo = update.message.photo[-1]  # è·å–æœ€é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡
        file = await context.bot.get_file(photo.file_id)
        image_bytes = await file.download_as_bytearray()
    except Exception as e:
        logger.error(f"è·å–å›¾ç‰‡å¤±è´¥: {e}")
        await update.message.reply_text("âŒ æ— æ³•è·å–æ‚¨å‘é€çš„å›¾ç‰‡ã€‚è¯·ç¨åå†è¯•ã€‚")
        return
    
    # æ‰§è¡ŒOCR
    extracted_text = extract_text_from_image(image_bytes)
    if not extracted_text:
        await update.message.reply_text("âŒ æ— æ³•ä»å›¾ç‰‡ä¸­æå–æ–‡æœ¬ã€‚è¯·ç¡®ä¿æˆªå›¾æ¸…æ™°å¹¶åŒ…å«ç›¸å…³ä¿¡æ¯ã€‚")
        return
    
    # è§£æå†…å®¹ï¼ˆç¤ºä¾‹ï¼šç›ˆåˆ©æˆ–äºæŸï¼‰
    profit, loss = parse_profit_loss_text(extracted_text)
    
    # ç”Ÿæˆåé¦ˆ
    if profit > 0:
        message = f"ğŸ‰ æ­å–œæ‚¨ï¼æœ¬æ¬¡äº¤æ˜“ç›ˆåˆ© **+{profit} USDT**ã€‚"
    elif loss > 0:
        message = f"âš ï¸ æ³¨æ„ï¼æœ¬æ¬¡äº¤æ˜“äºæŸ **-{loss} USDT**ã€‚"
    else:
        message = "â„¹ï¸ æˆ‘å·²æ”¶åˆ°æ‚¨çš„å›¾ç‰‡ï¼Œä½†æœªèƒ½è¯†åˆ«å…·ä½“å†…å®¹ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·ç›´æ¥å‘é€æ–‡å­—ä¿¡æ¯ã€‚"
    
    await update.message.reply_text(message)
